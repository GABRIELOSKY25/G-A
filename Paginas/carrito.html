<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito</title>
    <link rel="icon" href="../Logo_Principal.ico" type="image/x-icon">
    <link rel="stylesheet" href="../CSS/carrito.css">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
    <header>
        <div class="menu_navegacion">
            <div class="contenedor">
                <div class="logo">
                    <a href="../index.html">
                        <img src="../Logo_Principal.png" alt="G&A" style="width: 60px; height: auto;">
                    </a>
                </div>

                <nav>
                    <ul>
                        <li><a href="../index.html">Inicio</a></li>
                        <li><a href="catalogo.php">Catalogo</a></li>
                        <li><a href="oferta.php">Ofertas</a></li>
                        <li><a href="ubicacion.html">Ubicacion</a></li>
                        <li><a href="carrito.php">Carrito</a></li>
                        <li><a href="cuenta.php">Cuenta</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main id="app">
        <section class="carrito">
            <div class="contenedor">
                <h1>Carrito de Compras</h1>

                <div class="contendor_carrito">

                    <div class="obgeto_carrito">

                        <!-- Carrito vac√≠o -->
                        <div class="carrito-vacio" v-if="carrito.length === 0">
                            <div class="icono-carrito-vacio">üõí</div>
                            <h3>Tu carrito est√° vac√≠o</h3>
                            <p>Agrega algunos juegos incre√≠bles para comenzar</p>
                            <a href="./catalogo.php" class="boton_compra">Descubrir Juegos</a>
                        </div>

                        <!-- Items -->
                        <div class="item-carrito" v-for="item in carrito" :key="item.nombre">
                            <img :src="item.imagen" :alt="item.nombre" @error="manejarErrorImagen">

                            <div class="info-item">
                                <h4>{{ item.nombre }}</h4>

                                <div class="precios">
                                    <span class="precio_original" v-if="item.descuento">
                                        ${{ item.precioOriginal.toFixed(2) }}
                                    </span>

                                    <span :class="item.descuento ? 'precio_descuento' : 'precio_normal'">
                                        ${{ item.precio.toFixed(2) }}
                                    </span>

                                    <span class="descuento" v-if="item.descuento">
                                        -{{ item.descuento }}%
                                    </span>
                                </div>
                            </div>

                            <div class="controles-cantidad">
                                <button class="btn-cantidad" @click="disminuirCantidad(item.nombre)">-</button>
                                <span class="cantidad">{{ item.cantidad }}</span>
                                <button class="btn-cantidad" @click="aumentarCantidad(item.nombre)">+</button>
                            </div>

                            <div class="subtotal">
                                ${{ (item.precio * item.cantidad).toFixed(2) }}
                            </div>

                            <button class="btn-eliminar" @click="eliminarProducto(item.nombre)" title="Eliminar">√ó</button>
                        </div>

                    </div>

                    <!-- Resumen -->
                    <div class="resumen_carrito" v-if="carrito.length > 0">
                        <div class="resumen">
                            <h3>Resumen de Compra</h3>

                            <div class="detalles-resumen">
                                <div class="linea-resumen">
                                    <span>Productos ({{ totalItems }}):</span>
                                    <span>${{ subtotal.toFixed(2) }}</span>
                                </div>

                                <div class="linea-resumen">
                                    <span>Env√≠o:</span>
                                    <span>Gratis</span>
                                </div>

                                <div class="linea-resumen">
                                    <span>Impuestos:</span>
                                    <span>Incluidos</span>
                                </div>

                                <div class="separador"></div>

                                <div class="linea-resumen total">
                                    <strong>Total:</strong>
                                    <strong>${{ total.toFixed(2) }}</strong>
                                </div>
                            </div>

                            <button class="boton_compra btn-pagar" @click="procesarPago">Proceder al Pago</button>
                            <button class="btn-vaciar-carrito" @click="vaciarCarrito">Vaciar Carrito</button>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Mensaje flotante -->
        <div class="mensaje-carrito" v-if="mensaje.visible"
            :style="{
                position: 'fixed',
                top: '100px',
                right: '20px',
                background: '#ffffff',
                color: '#050524',
                padding: '1rem 2rem',
                borderRadius: '10px',
                fontWeight: '600',
                zIndex: '10000',
                animation: 'slideIn 0.3s ease',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.3)'
            }">
            {{ mensaje.texto }}
        </div>

    </main>

    <footer>
        <div class="contenedor">
            <div class="espacio_footer">

                <div class="seccion_footer">
                    <h3>G&A</h3>
                    <p>Tu plataforma de videojuegos de confianza</p>
                </div>

                <div class="seccion_footer">
                    <h4>Descubrir</h4>
                    <ul>
                        <li><a href="../index.html">Inicio</a></li>
                        <li><a href="./catalogo.php">Cat√°logo</a></li>
                        <li><a href="./oferta.php">Ofertas</a></li>
                        <li><a href="./ubicacion.html">Ubicaci√≥n</a></li>
                        <li><a href="./carrito.php">Carrito</a></li>
                    </ul>
                </div>

                <div class="seccion_footer">
                    <h4>Soporte</h4>
                    <ul>
                        <li><a href="./soporte.php">Soporte</a></li>
                        <li><a href="./cuenta.php">Cuenta</a></li>
                    </ul>
                </div>

                <div class="seccion_footer">
                    <h4>Valores</h4>
                    <ul>
                        <li><a href="./terminos.html">T√©rminos y condiciones</a></li>
                        <li><a href="./privacidad.html">Pol√≠tica de privacidad</a></li>
                    </ul>
                </div>

                <div class="seccion_footer">
                    <h4>S√≠guenos</h4>
                    <div class="link_social">
                        <ul>
                            <li><a href="#" target="_blank"><img src="../Imagenes/Redes Sociales/facebook.jpg"></a></li>
                            <li><a href="#" target="_blank"><img src="../Imagenes/Redes Sociales/x.jpg"></a></li>
                            <li><a href="#" target="_blank"><img src="../Imagenes/Redes Sociales/instagram.jpg"></a></li>
                        </ul>
                    </div>
                </div>

            </div>

            <div class="derechos">
                <p>&copy; 2025 G&A. Todos los derechos reservados</p>
            </div>
        </div>
    </footer>

    <!-- L√≥gica Vue -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    carrito: [],
                    mensaje: {
                        texto: "",
                        visible: false
                    }
                };
            },

            computed: {
                totalItems() {
                    return this.carrito.reduce((t, i) => t + i.cantidad, 0);
                },
                subtotal() {
                    return this.carrito.reduce((t, i) => t + i.precio * i.cantidad, 0);
                },
                total() {
                    return this.subtotal;
                }
            },

            mounted() {
                this.cargarCarrito();
                this.actualizarContadorCarrito();
            },

            methods: {

                cargarCarrito() {
                    const guardado = localStorage.getItem("carrito");
                    this.carrito = guardado ? JSON.parse(guardado) : [];
                },

                guardarCarrito() {
                    localStorage.setItem("carrito", JSON.stringify(this.carrito));
                    this.actualizarContadorCarrito();
                },

                actualizarContadorCarrito() {
                    const total = this.totalItems;
                    const elementos = document.querySelectorAll(".contador-carrito");

                    elementos.forEach(el => {
                        el.textContent = total;
                        el.style.display = total > 0 ? "inline-block" : "none";
                    });

                    localStorage.setItem("carritoCount", total);
                },

                aumentarCantidad(nombre) {
                    const item = this.carrito.find(i => i.nombre === nombre);
                    if (item) {
                        item.cantidad++;
                        this.guardarCarrito();
                    }
                },

                disminuirCantidad(nombre) {
                    const item = this.carrito.find(i => i.nombre === nombre);
                    if (!item) return;

                    if (item.cantidad > 1) {
                        item.cantidad--;
                    } else {
                        this.eliminarProducto(nombre);
                        return;
                    }
                    this.guardarCarrito();
                },

                eliminarProducto(nombre) {
                    this.carrito = this.carrito.filter(i => i.nombre !== nombre);
                    this.guardarCarrito();
                    this.mostrarMensaje("Producto eliminado del carrito");
                },

                vaciarCarrito() {
                    if (this.carrito.length === 0) {
                        this.mostrarMensaje("El carrito ya est√° vac√≠o");
                        return;
                    }

                    this.carrito = [];
                    this.guardarCarrito();
                    this.mostrarMensaje("Carrito vaciado");
                },

                procesarPago() {
    if (this.carrito.length === 0) {
        this.mostrarMensaje("Tu carrito est√° vac√≠o");
        return;
    }

    const datosVenta = {
        carrito: this.carrito,
        correo: localStorage.getItem("correo_usuario"),
        total: this.total
    };

    // üîç DEBUG: Mostrar lo que se enviar√°
    console.log("üì¶ DATOS QUE SE ENVIAN AL SERVIDOR:", datosVenta);

    fetch("../Paginas/procesar_venta.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datosVenta)
    })
        .then(async res => {
            // üîç DEBUG: ver si el servidor responde HTML (lo cual indica error)
            const text = await res.text();
            console.log("üì• RESPUESTA DEL SERVIDOR (RAW):", text);

            try {
                return JSON.parse(text);
            } catch (e) {
                console.error("‚ùå ERROR: El servidor no devolvi√≥ JSON v√°lido");
                this.mostrarMensaje("Error al procesar: respuesta inv√°lida del servidor");
                return null;
            }
        })
        .then(data => {
            if (!data) return; // si hubo error en JSON

            if (data.success) {
                this.mostrarMensaje("¬°Compra realizada con √©xito!");

                this.carrito = [];
                this.guardarCarrito();
            } else {
                this.mostrarMensaje("Error: " + data.message);
            }
        })
        .catch(err => {
            this.mostrarMensaje("Error al procesar la venta");
            console.error("‚ùå ERROR EN FETCH:", err);
        });
},

                manejarErrorImagen(event) {
                    event.target.src = "../Imagenes/error_imagen.jpg";
                },

                mostrarMensaje(texto) {
                    this.mensaje.texto = texto;
                    this.mensaje.visible = true;

                    setTimeout(() => {
                        this.mensaje.visible = false;
                    }, 3000);
                }
            }
        }).mount("#app");
    </script>

</body>

</html>
